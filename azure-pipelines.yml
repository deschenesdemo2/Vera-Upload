trigger:
 branches:
   include:
   - refs/heads/master
   - refs/heads/dev
   - refs/heads/featureX

pool:
  vmImage: 'ubuntu-latest'

stages:

  - stage: BasePipelineFeatureXBranch
    displayName: 'Veracode Security Scans - FeatureX Branch'
    condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/featureX'))

    jobs:

    - job: 'Build'
      displayName: 'Build'

      steps:

      - task: Maven@3
        inputs:
          mavenPomFile: 'app/pom.xml'
          goals: 'package' # Optional
          options: # Optional
          publishJUnitResults: true
          testResultsFiles: '**/surefire-reports/TEST-*.xml' # Required when publishJUnitResults == True
          testRunTitle: # Optional
          codeCoverageToolOption: 'None' # Optional. Options: none, cobertura, jaCoCo. Enabling code coverage inserts the `clean` goal into the Maven goals list when Maven runs.
          codeCoverageClassFilter: # Optional. Comma-separated list of filters to include or exclude classes from collecting code coverage. For example: +:com.*,+:org.*,-:my.app*.*
          codeCoverageClassFilesDirectories: # Optional
          codeCoverageSourceDirectories: # Optional
          codeCoverageFailIfEmpty: false # Optional
          javaHomeOption: 'JDKVersion' # Options: jDKVersion, path
          jdkVersionOption: 'default' # Optional. Options: default, 1.11, 1.10, 1.9, 1.8, 1.7, 1.6
          jdkDirectory: # Required when javaHomeOption == Path
          jdkArchitectureOption: 'x64' # Optional. Options: x86, x64
          mavenVersionOption: 'Default' # Options: default, path
          mavenDirectory: # Required when mavenVersionOption == Path
          mavenSetM2Home: false # Required when mavenVersionOption == Path
          mavenOptions: '-Xmx1024m' # Optional
          mavenAuthenticateFeed: false
          effectivePomSkip: false
          sonarQubeRunAnalysis: false
          sqMavenPluginVersionChoice: 'latest' # Required when sonarQubeRunAnalysis == True# Options: latest, pom
          checkStyleRunAnalysis: false # Optional
          pmdRunAnalysis: false # Optional
          findBugsRunAnalysis: false # Optional

      - task: PublishPipelineArtifact@1
        condition: succeeded()
        inputs:
          targetPath: 'app/target/verademo.war'
          artifact: verademo_package

    - job: 'SAST_PipelineScan'
      displayName: 'Veracode SAST - Pipeline Scan'
      dependsOn: Build
      steps:
      - script: echo '[INFO] Starting Veracode SAST - Pipeline Scan'
      - template: "azureTemplates/VeracodePipelineScan.yml"



#    - template: "azureTemplates/VeracodeSCA.yml"
#    - template: "azureTemplates/VeracodeContainerSecurity.yml"
